(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{QtVZ:function(e,t,n){"use strict";n.r(t);n("bbsP");var r=n("/wGt"),a=n("jehZ"),i=n.n(a),o=(n("14J3"),n("BMrR")),s=(n("P2fV"),n("NJEC")),c=(n("qVdP"),n("jsC+")),l=(n("Pwec"),n("CtXQ")),u=(n("jCWc"),n("kPKH")),m=(n("lUTK"),n("BvKs")),d=(n("+L6B"),n("2/Rp")),f=(n("miYZ"),n("tsqr")),h=n("d6i3"),p=n.n(h),y=n("1l/V"),v=n.n(y),b=n("2Taf"),C=n.n(b),k=n("vZ4D"),g=n.n(k),E=n("MhPg"),x=n.n(E),S=n("l4Ni"),w=n.n(S),D=n("ujKo"),R=n.n(D),V=n("q1tI"),j=n.n(V),M=n("MuoO"),A=n("w2z3"),B=(n("y8nQ"),n("Vl3Y")),F=n("HP82"),O=n("8YRU");function P(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var n,r=R()(e);if(t){var a=R()(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return w()(this,n)}}var q,T={labelCol:{xs:{span:18},sm:{span:4}},wrapperCol:{xs:{span:24},sm:{span:18}}},G=function(e){x()(n,e);var t=P(n);function n(){var e;return C()(this,n),(e=t.call(this)).state={submitting:!1,users:void 0,groups:void 0},e}return g()(n,[{key:"componentDidMount",value:function(){var e=v()(p.a.mark(function e(){var t,n,r,a,i,o,s,c;return p.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.props.initData,n=void 0===t?{}:t,e.next=3,Object(F.queryContent)({model:"guardian__groupobjectpermission",expandFields:["group"],filters:[{field:"permission__codename",operator:"=",value:"view_chart"},{field:"content_type__app_label",operator:"=",value:"chart"},{field:"object_pk",operator:"=",value:n.id}]});case 3:return r=e.sent,a=r.list,e.next=7,Object(F.queryContent)({model:"guardian__userobjectpermission",expandFields:["user"],filters:[{field:"permission__codename",operator:"=",value:"view_chart"},{field:"content_type__app_label",operator:"=",value:"chart"},{field:"object_pk",operator:"=",value:n.id}]});case 7:i=e.sent,o=i.list,s=o.map(function(e){return e.user}),c=a.map(function(e){return e.group}),this.setState({users:s,groups:c});case 12:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"handleSubmit",value:function(){var e=v()(p.a.mark(function e(t){var n,r,a,i;return p.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.props,r=n.initData,a=n.afterSubmit,(i=_.cloneDeep(t)).data_id=r.id,i.to_groups=i.to_groups.map(function(e){return e.id}),i.to_user=i.to_user.map(function(e){return e.id}),i.codename="chart.view_chart",e.next=8,Object(F.chartShowAdmin)(i);case 8:a();case 9:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"handleSubmitButtonClick",value:function(){var e=this;this.props.form.validateFields(function(t,n){t||e.handleSubmit(n)})}},{key:"handleReset",value:function(){this.props.form.resetFields()}},{key:"renderGroups",value:function(){var e=this.props.form.getFieldDecorator,t=this.state.groups;return t?j.a.createElement(B.a.Item,{label:"仅此角色可见"},e("to_groups",{initialValue:t})(j.a.createElement(O.a,{field:{displayName:"角色",name:"group",ref:"auth__group",refField:"permissions",refTo:"id",required:!1,type:"mref"},style:{width:300}}))):null}},{key:"renderUser",value:function(){var e=this.props.form.getFieldDecorator,t=this.state.users;return t?j.a.createElement(B.a.Item,{label:"仅此用户可见"},e("to_user",{initialValue:t})(j.a.createElement(O.a,{field:{displayName:"用户",name:"user",ref:"member__user",refField:"user_permissions",refTo:"id",required:!1,type:"mref"},style:{width:300}}))):null}},{key:"render",value:function(){var e=this,t=this.state.submitting;return j.a.createElement(B.a,i()({onSubmit:this.handleSubmit},T),this.renderGroups(),this.renderUser(),j.a.createElement(B.a.Item,null,j.a.createElement(d.a,{type:"primary",loading:t,onClick:function(){return e.handleSubmitButtonClick()}},"提交"),j.a.createElement(d.a,{style:{left:10},onClick:function(){return e.handleReset()}},"重置")))}}]),n}(V.Component),I=B.a.create({name:"chartGrou"})(G),N=n("Oix3"),U=n("SSXS");function z(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var n,r=R()(e);if(t){var a=R()(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return w()(this,n)}}var J={},K=function(e){var t=e.metrics,n=e.dimensions,r={title:e.name,model:e.model,fields:{},metrics:[],groupBy:"",filters:[]};t.forEach(function(e){var t={field:e.field,method:e.method,displayName:e.display_name,format:e.format},n={metric:e.name,geom:e.geom};r.metrics.push(n),r.fields[e.name]=t}),n.forEach(function(e){var t={field:e.field,displayName:e.display_name};e.method&&(t.method=e.method),r.fields[e.name]=t,"groupby"===e.name&&(r.groupBy=e.name),"legend"===e.name&&(r.legend=e.name)}),J[e.id]=r},Z=function(e){e.forEach(function(e){K(e)})},Q=Object(M.connect)(function(e){return{schemas:e.content.schemas,currentUser:e.user.currentUser}})(q=function(e){x()(n,e);var t=z(n);function n(){var e;return C()(this,n),(e=t.call(this)).state={formModalVisible:!1,chartAdminVisible:!1,charts:[],currentChart:void 0},e}return g()(n,[{key:"componentDidMount",value:function(){var e=v()(p.a.mark(function e(){var t,n;return p.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(F.queryContent)({model:"chart__chart",filters:[],orderBy:["id"],expandFields:["metrics","dimensions","chart_filters"]},1,1e3);case 2:t=e.sent,n=t.list,Z(n),this.setState({charts:n});case 6:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"onSubmitChart",value:function(e,t){var n=this.state.charts;"create"===e?(n.push(t),K(t)):n.forEach(function(e,r){e.id===t.id&&(n[r]=t,K(t))}),this.setState({charts:n}),this.setState({formModalVisible:!1})}},{key:"onEditChart",value:function(e){this.setState({currentChart:e,formModalVisible:!0})}},{key:"onDeleteChart",value:function(e){this.setState({currentChart:e})}},{key:"onChartAdmin",value:function(e){this.setState({currentChart:e,chartAdminVisible:!0})}},{key:"onSubmintChartGrou",value:function(){this.setState({chartAdminVisible:!1})}},{key:"handleModalCancel",value:function(){this.setState({formModalVisible:!1,chartAdminVisible:!1})}},{key:"addChart",value:function(){this.setState({currentChart:void 0,formModalVisible:!0})}},{key:"handleChartDelete",value:function(){var e=v()(p.a.mark(function e(){var t,n,r,a;return p.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.state,n=t.currentChart,r=t.charts,e.prev=1,e.next=4,Object(F.deleteContent)({model:"chart__chart",id:n.id});case 4:e.next=10;break;case 6:return e.prev=6,e.t0=e.catch(1),f.a.error("删除失败"),e.abrupt("return");case 10:a=r.map(function(e){return e.id}).indexOf(n.id),r.splice(a,1),this.setState({charts:r}),f.a.success("删除成功");case 14:case"end":return e.stop()}},e,this,[[1,6]])}));return function(){return e.apply(this,arguments)}}()},{key:"handelChartEdit",value:function(e){var t=this.state.charts;_.find(t,{id:e})&&this.setState({formModalVisible:!0})}},{key:"renderChart",value:function(e){var t=this,n=j.a.createElement(m.a,null,j.a.createElement(m.a.Item,{key:"1"},j.a.createElement(d.a,{type:"default",size:"small",onClick:function(){t.onEditChart(e)},style:{marginRight:"5px"},icon:"form"},"图表编辑")),j.a.createElement(m.a.Item,{key:"2"},j.a.createElement(d.a,{type:"default",size:"small",style:{marginRight:"5px"},icon:"eye",onClick:function(){t.onChartAdmin(e)}},"图表权限")));return j.a.createElement(u.a,{span:11,style:{backgroundColor:"white",marginRight:"30px",marginBottom:"30px",padding:"10px",minWidth:"500px"}},j.a.createElement(o.a,{type:"flex",justify:"space-between",style:{marginTop:"5px"}},j.a.createElement(u.a,{style:{marginLeft:"5px",fontSize:"1.2em"}},j.a.createElement("span",null,e.name)),j.a.createElement(u.a,{style:{marginRight:"5px"}},j.a.createElement("div",null,j.a.createElement(c.a,{overlay:n,onClick:function(e){return e.preventDefault()}},j.a.createElement(l.a,{type:"setting"})),j.a.createElement(s.a,{title:"确认删除图表么?",onConfirm:function(){t.handleChartDelete()},okText:"删除",cancelText:"取消",key:"delete"},j.a.createElement(d.a,{onClick:function(){t.onDeleteChart(e)},style:{margin:5,border:0},icon:"delete"}))))),j.a.createElement(N.a,i()({},J[e.id],{key:e.id,id:e.id})))}},{key:"render",value:function(){var e=this,t=this.props.schemas,n=this.state,a=n.formModalVisible,i=n.charts,s=n.currentChart,c=n.chartAdminVisible;return j.a.createElement("div",null,j.a.createElement(o.a,{type:"flex",justify:"start"},i.map(function(t){return e.renderChart(t)}),j.a.createElement(u.a,{span:11},j.a.createElement(d.a,{type:"dashed",style:{width:"100%",height:"540px"},onClick:function(){e.addChart()}},j.a.createElement("div",null,j.a.createElement(l.a,{type:"plus-circle",theme:"filled",style:{fontSize:"5em"}})),j.a.createElement("div",{style:{marginTop:"10px"}},"添加图表")))),j.a.createElement(r.a,{title:"".concat(s?"编辑":"添加","图表"),placement:"right",width:800,onClose:function(){e.handleModalCancel()},visible:a,key:"form"},j.a.createElement(A.a,{key:s&&s.id,schemas:t,templates:U.a,initData:s,afterSubmit:function(t,n){e.onSubmitChart(t,n)}})),j.a.createElement(r.a,{title:"查看权限设置",placement:"right",width:800,visible:c,key:"chartAdmin",onClose:function(){e.handleModalCancel()}},j.a.createElement(I,{key:s&&s.id,initData:s,afterSubmit:function(){e.onSubmintChartGrou()}})))}}]),n}(V.Component))||q;t.default=Q}}]);