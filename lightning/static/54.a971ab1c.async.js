(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[54],{QtVZ:function(e,t,n){"use strict";n.r(t);n("bbsP");var r=n("/wGt"),a=n("jehZ"),i=n.n(a),s=(n("14J3"),n("BMrR")),o=(n("P2fV"),n("NJEC")),c=(n("qVdP"),n("jsC+")),l=(n("Pwec"),n("CtXQ")),u=(n("jCWc"),n("kPKH")),m=(n("lUTK"),n("BvKs")),d=(n("+L6B"),n("2/Rp")),f=(n("miYZ"),n("tsqr")),h=n("d6i3"),p=n.n(h),v=n("1l/V"),y=n.n(v),b=n("2Taf"),C=n.n(b),k=n("vZ4D"),g=n.n(k),E=n("MhPg"),x=n.n(E),w=n("l4Ni"),S=n.n(w),D=n("ujKo"),R=n.n(D),V=n("q1tI"),j=n.n(V),M=n("MuoO"),B=n("w2z3"),F=(n("y8nQ"),n("Vl3Y")),O=n("HP82"),P=n("8YRU");function A(e){var t=T();return function(){var n,r=R()(e);if(t){var a=R()(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return S()(this,n)}}function T(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}var G,I,N={labelCol:{xs:{span:18},sm:{span:4}},wrapperCol:{xs:{span:24},sm:{span:18}}},U=function(e){x()(n,e);var t=A(n);function n(){var e;return C()(this,n),e=t.call(this),e.state={submitting:!1,users:void 0,groups:void 0},e}return g()(n,[{key:"componentDidMount",value:function(){var e=y()(p.a.mark(function e(){var t,n,r,a,i,s,o,c;return p.a.wrap(function(e){while(1)switch(e.prev=e.next){case 0:return t=this.props.initData,n=void 0===t?{}:t,e.next=3,Object(O["C"])({model:"guardian__groupobjectpermission",expandFields:["group"],filters:[{field:"permission__codename",operator:"=",value:"view_chart"},{field:"content_type__app_label",operator:"=",value:"chart"},{field:"object_pk",operator:"=",value:n.id}]});case 3:return r=e.sent,a=r.list,e.next=7,Object(O["C"])({model:"guardian__userobjectpermission",expandFields:["user"],filters:[{field:"permission__codename",operator:"=",value:"view_chart"},{field:"content_type__app_label",operator:"=",value:"chart"},{field:"object_pk",operator:"=",value:n.id}]});case 7:i=e.sent,s=i.list,o=s.map(function(e){return e.user}),c=a.map(function(e){return e.group}),this.setState({users:o,groups:c});case 12:case"end":return e.stop()}},e,this)}));function t(){return e.apply(this,arguments)}return t}()},{key:"handleSubmit",value:function(){var e=y()(p.a.mark(function e(t){var n,r,a,i;return p.a.wrap(function(e){while(1)switch(e.prev=e.next){case 0:return n=this.props,r=n.initData,a=n.afterSubmit,i=_.cloneDeep(t),i.data_id=r.id,i.to_groups=i.to_groups.map(function(e){return e.id}),i.to_user=i.to_user.map(function(e){return e.id}),i.codename="chart.view_chart",e.next=8,Object(O["d"])(i);case 8:a();case 9:case"end":return e.stop()}},e,this)}));function t(t){return e.apply(this,arguments)}return t}()},{key:"handleSubmitButtonClick",value:function(){var e=this,t=this.props.form;t.validateFields(function(t,n){t||e.handleSubmit(n)})}},{key:"handleReset",value:function(){var e=this.props.form;e.resetFields()}},{key:"renderGroups",value:function(){var e=this.props.form.getFieldDecorator,t=this.state.groups;return t?j.a.createElement(F["a"].Item,{label:"\u4ec5\u6b64\u89d2\u8272\u53ef\u89c1"},e("to_groups",{initialValue:t})(j.a.createElement(P["a"],{field:{displayName:"\u89d2\u8272",name:"group",ref:"auth__group",refField:"permissions",refTo:"id",required:!1,type:"mref"},style:{width:300}}))):null}},{key:"renderUser",value:function(){var e=this.props.form.getFieldDecorator,t=this.state.users;return t?j.a.createElement(F["a"].Item,{label:"\u4ec5\u6b64\u7528\u6237\u53ef\u89c1"},e("to_user",{initialValue:t})(j.a.createElement(P["a"],{field:{displayName:"\u7528\u6237",name:"user",ref:"member__user",refField:"user_permissions",refTo:"id",required:!1,type:"mref"},style:{width:300}}))):null}},{key:"render",value:function(){var e=this,t=this.state.submitting;return j.a.createElement(F["a"],i()({onSubmit:this.handleSubmit},N),this.renderGroups(),this.renderUser(),j.a.createElement(F["a"].Item,null,j.a.createElement(d["a"],{type:"primary",loading:t,onClick:function(){return e.handleSubmitButtonClick()}},"\u63d0\u4ea4"),j.a.createElement(d["a"],{style:{left:10},onClick:function(){return e.handleReset()}},"\u91cd\u7f6e")))}}]),n}(V["Component"]),q=F["a"].create({name:"chartGrou"})(U),z=q,J=n("Oix3"),K=n("SSXS");function Z(e){var t=Q();return function(){var n,r=R()(e);if(t){var a=R()(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return S()(this,n)}}function Q(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}var Y={},H=function(e){var t=e.metrics,n=e.dimensions,r={title:e.name,model:e.model,fields:{},metrics:[],groupBy:"",filters:[]};t.forEach(function(e){var t={field:e.field,method:e.method,displayName:e.display_name,format:e.format},n={metric:e.name,geom:e.geom};r.metrics.push(n),r.fields[e.name]=t}),n.forEach(function(e){var t={field:e.field,displayName:e.display_name};e.method&&(t.method=e.method),r.fields[e.name]=t,"groupby"===e.name&&(r.groupBy=e.name),"legend"===e.name&&(r.legend=e.name)}),Y[e.id]=r},L=function(e){e.forEach(function(e){H(e)})},W=(G=Object(M["connect"])(function(e){var t=e.content.schemas,n=e.user.currentUser;return{schemas:t,currentUser:n}}),G(I=function(e){x()(n,e);var t=Z(n);function n(){var e;return C()(this,n),e=t.call(this),e.state={formModalVisible:!1,chartAdminVisible:!1,charts:[],currentChart:void 0},e}return g()(n,[{key:"componentDidMount",value:function(){var e=y()(p.a.mark(function e(){var t,n;return p.a.wrap(function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,Object(O["C"])({model:"chart__chart",filters:[],orderBy:["id"],expandFields:["metrics","dimensions","chart_filters"]},1,1e3);case 2:t=e.sent,n=t.list,L(n),this.setState({charts:n});case 6:case"end":return e.stop()}},e,this)}));function t(){return e.apply(this,arguments)}return t}()},{key:"onSubmitChart",value:function(e,t){var n=this.state.charts;"create"===e?(n.push(t),H(t)):n.forEach(function(e,r){e.id===t.id&&(n[r]=t,H(t))}),this.setState({charts:n}),this.setState({formModalVisible:!1})}},{key:"onEditChart",value:function(e){this.setState({currentChart:e,formModalVisible:!0})}},{key:"onDeleteChart",value:function(e){this.setState({currentChart:e})}},{key:"onChartAdmin",value:function(e){this.setState({currentChart:e,chartAdminVisible:!0})}},{key:"onSubmintChartGrou",value:function(){this.setState({chartAdminVisible:!1})}},{key:"handleModalCancel",value:function(){this.setState({formModalVisible:!1,chartAdminVisible:!1})}},{key:"addChart",value:function(){this.setState({currentChart:void 0,formModalVisible:!0})}},{key:"handleChartDelete",value:function(){var e=y()(p.a.mark(function e(){var t,n,r,a;return p.a.wrap(function(e){while(1)switch(e.prev=e.next){case 0:return t=this.state,n=t.currentChart,r=t.charts,e.prev=1,e.next=4,Object(O["l"])({model:"chart__chart",id:n.id});case 4:e.next=10;break;case 6:return e.prev=6,e.t0=e["catch"](1),f["a"].error("\u5220\u9664\u5931\u8d25"),e.abrupt("return");case 10:a=r.map(function(e){return e.id}).indexOf(n.id),r.splice(a,1),this.setState({charts:r}),f["a"].success("\u5220\u9664\u6210\u529f");case 14:case"end":return e.stop()}},e,this,[[1,6]])}));function t(){return e.apply(this,arguments)}return t}()},{key:"handelChartEdit",value:function(e){var t=this.state.charts,n=_.find(t,{id:e});n&&this.setState({formModalVisible:!0})}},{key:"renderChart",value:function(e){var t=this,n=j.a.createElement(m["a"],null,j.a.createElement(m["a"].Item,{key:"1"},j.a.createElement(d["a"],{type:"default",size:"small",onClick:function(){t.onEditChart(e)},style:{marginRight:"5px"},icon:"form"},"\u56fe\u8868\u7f16\u8f91")),j.a.createElement(m["a"].Item,{key:"2"},j.a.createElement(d["a"],{type:"default",size:"small",style:{marginRight:"5px"},icon:"eye",onClick:function(){t.onChartAdmin(e)}},"\u56fe\u8868\u6743\u9650")));return j.a.createElement(u["a"],{span:11,style:{backgroundColor:"white",marginRight:"30px",marginBottom:"30px",padding:"10px",minWidth:"500px"}},j.a.createElement(s["a"],{type:"flex",justify:"space-between",style:{marginTop:"5px"}},j.a.createElement(u["a"],{style:{marginLeft:"5px",fontSize:"1.2em"}},j.a.createElement("span",null,e.name)),j.a.createElement(u["a"],{style:{marginRight:"5px"}},j.a.createElement("div",null,j.a.createElement(c["a"],{overlay:n,onClick:function(e){return e.preventDefault()}},j.a.createElement(l["a"],{type:"setting"})),j.a.createElement(o["a"],{title:"\u786e\u8ba4\u5220\u9664\u56fe\u8868\u4e48?",onConfirm:function(){t.handleChartDelete()},okText:"\u5220\u9664",cancelText:"\u53d6\u6d88",key:"delete"},j.a.createElement(d["a"],{onClick:function(){t.onDeleteChart(e)},style:{margin:5,border:0},icon:"delete"}))))),j.a.createElement(J["a"],i()({},Y[e.id],{key:e.id,id:e.id})))}},{key:"render",value:function(){var e=this,t=this.props.schemas,n=this.state,a=n.formModalVisible,i=n.charts,o=n.currentChart,c=n.chartAdminVisible;return j.a.createElement("div",null,j.a.createElement(s["a"],{type:"flex",justify:"start"},i.map(function(t){return e.renderChart(t)}),j.a.createElement(u["a"],{span:11},j.a.createElement(d["a"],{type:"dashed",style:{width:"100%",height:"540px"},onClick:function(){e.addChart()}},j.a.createElement("div",null,j.a.createElement(l["a"],{type:"plus-circle",theme:"filled",style:{fontSize:"5em"}})),j.a.createElement("div",{style:{marginTop:"10px"}},"\u6dfb\u52a0\u56fe\u8868")))),j.a.createElement(r["a"],{title:"".concat(o?"\u7f16\u8f91":"\u6dfb\u52a0","\u56fe\u8868"),placement:"right",width:800,onClose:function(){e.handleModalCancel()},visible:a,key:"form"},j.a.createElement(B["a"],{key:o&&o.id,schemas:t,templates:K["a"],initData:o,afterSubmit:function(t,n){e.onSubmitChart(t,n)}})),j.a.createElement(r["a"],{title:"\u67e5\u770b\u6743\u9650\u8bbe\u7f6e",placement:"right",width:800,visible:c,key:"chartAdmin",onClose:function(){e.handleModalCancel()}},j.a.createElement(z,{key:o&&o.id,initData:o,afterSubmit:function(){e.onSubmintChartGrou()}})))}}]),n}(V["Component"]))||I);t["default"]=W}}]);