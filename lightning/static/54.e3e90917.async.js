(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[54],{QtVZ:function(e,t,n){"use strict";n.r(t);n("bbsP");var r=n("/wGt"),a=(n("14J3"),n("BMrR")),i=(n("P2fV"),n("NJEC")),s=(n("qVdP"),n("jsC+")),o=(n("Pwec"),n("CtXQ")),c=(n("jCWc"),n("kPKH")),l=(n("lUTK"),n("BvKs")),u=(n("+L6B"),n("2/Rp")),m=(n("miYZ"),n("tsqr")),d=n("d6i3"),f=n.n(d),h=n("1l/V"),p=n.n(h),v=n("2Taf"),y=n.n(v),b=n("vZ4D"),C=n.n(b),g=n("MhPg"),k=n.n(g),E=n("l4Ni"),w=n.n(E),x=n("ujKo"),S=n.n(x),D=n("q1tI"),R=n.n(D),V=n("MuoO"),j=n("w2z3"),M=n("jehZ"),B=n.n(M),F=(n("y8nQ"),n("Vl3Y")),P=n("HP82"),A=n("8YRU");function O(e){var t=T();return function(){var n,r=S()(e);if(t){var a=S()(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return w()(this,n)}}function T(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}var G,I,N={labelCol:{xs:{span:18},sm:{span:4}},wrapperCol:{xs:{span:24},sm:{span:18}}},U=function(e){k()(n,e);var t=O(n);function n(){var e;return y()(this,n),e=t.call(this),e.state={submitting:!1,users:void 0,groups:void 0},e}return C()(n,[{key:"componentDidMount",value:function(){var e=p()(f.a.mark(function e(){var t,n,r,a,i,s,o,c;return f.a.wrap(function(e){while(1)switch(e.prev=e.next){case 0:return t=this.props.initData,n=void 0===t?{}:t,e.next=3,Object(P["C"])({model:"guardian__groupobjectpermission",expandFields:["group"],filters:[{field:"permission__codename",operator:"=",value:"view_chart"},{field:"content_type__app_label",operator:"=",value:"chart"},{field:"object_pk",operator:"=",value:n.id}]});case 3:return r=e.sent,a=r.list,e.next=7,Object(P["C"])({model:"guardian__userobjectpermission",expandFields:["user"],filters:[{field:"permission__codename",operator:"=",value:"view_chart"},{field:"content_type__app_label",operator:"=",value:"chart"},{field:"object_pk",operator:"=",value:n.id}]});case 7:i=e.sent,s=i.list,o=s.map(function(e){return e.user}),c=a.map(function(e){return e.group}),this.setState({users:o,groups:c});case 12:case"end":return e.stop()}},e,this)}));function t(){return e.apply(this,arguments)}return t}()},{key:"handleSubmit",value:function(){var e=p()(f.a.mark(function e(t){var n,r,a,i;return f.a.wrap(function(e){while(1)switch(e.prev=e.next){case 0:return n=this.props,r=n.initData,a=n.afterSubmit,i=_.cloneDeep(t),i.data_id=r.id,i.to_groups=i.to_groups.map(function(e){return e.id}),i.to_user=i.to_user.map(function(e){return e.id}),i.codename="chart.view_chart",e.next=8,Object(P["d"])(i);case 8:a();case 9:case"end":return e.stop()}},e,this)}));function t(t){return e.apply(this,arguments)}return t}()},{key:"handleSubmitButtonClick",value:function(){var e=this,t=this.props.form;t.validateFields(function(t,n){t||e.handleSubmit(n)})}},{key:"handleReset",value:function(){var e=this.props.form;e.resetFields()}},{key:"renderGroups",value:function(){var e=this.props.form.getFieldDecorator,t=this.state.groups;return t?R.a.createElement(F["a"].Item,{label:"\u4ec5\u6b64\u89d2\u8272\u53ef\u89c1"},e("to_groups",{initialValue:t})(R.a.createElement(A["a"],{field:{displayName:"\u89d2\u8272",name:"group",ref:"auth__group",refField:"permissions",refTo:"id",required:!1,type:"mref"},style:{width:300}}))):null}},{key:"renderUser",value:function(){var e=this.props.form.getFieldDecorator,t=this.state.users;return t?R.a.createElement(F["a"].Item,{label:"\u4ec5\u6b64\u7528\u6237\u53ef\u89c1"},e("to_user",{initialValue:t})(R.a.createElement(A["a"],{field:{displayName:"\u7528\u6237",name:"user",ref:"member__user",refField:"user_permissions",refTo:"id",required:!1,type:"mref"},style:{width:300}}))):null}},{key:"render",value:function(){var e=this,t=this.state.submitting;return R.a.createElement(F["a"],B()({onSubmit:this.handleSubmit},N),this.renderGroups(),this.renderUser(),R.a.createElement(F["a"].Item,null,R.a.createElement(u["a"],{type:"primary",loading:t,onClick:function(){return e.handleSubmitButtonClick()}},"\u63d0\u4ea4"),R.a.createElement(u["a"],{style:{left:10},onClick:function(){return e.handleReset()}},"\u91cd\u7f6e")))}}]),n}(D["Component"]),q=F["a"].create({name:"chartGrou"})(U),z=q,J=n("5CwG"),K=n("SSXS");function Z(e){var t=Q();return function(){var n,r=S()(e);if(t){var a=S()(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return w()(this,n)}}function Q(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}var Y={},H=function(e){var t=e.metrics,n=e.dimensions,r={title:e.name,model:e.model,fields:{},metrics:[],groupBy:"",filters:[]};t.forEach(function(e){var t={field:e.field,method:e.method,displayName:e.display_name,format:e.format},n={metric:e.name,geom:e.geom};r.metrics.push(n),r.fields[e.name]=t}),n.forEach(function(e){var t={field:e.field,displayName:e.display_name};e.method&&(t.method=e.method),r.fields[e.name]=t,"groupby"===e.name&&(r.groupBy=e.name),"legend"===e.name&&(r.legend=e.name)}),Y[e.id]=r},L=function(e){e.forEach(function(e){H(e)})},W=(G=Object(V["connect"])(function(e){var t=e.content.schemas,n=e.user.currentUser;return{schemas:t,currentUser:n}}),G(I=function(e){k()(n,e);var t=Z(n);function n(){var e;return y()(this,n),e=t.call(this),e.state={formModalVisible:!1,chartAdminVisible:!1,charts:[],currentChart:void 0},e}return C()(n,[{key:"componentDidMount",value:function(){var e=p()(f.a.mark(function e(){var t,n;return f.a.wrap(function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,Object(P["C"])({model:"chart__chart",filters:[],orderBy:["id"],expandFields:["metrics","dimensions","chart_filters"]},1,1e3);case 2:t=e.sent,n=t.list,L(n),this.setState({charts:n});case 6:case"end":return e.stop()}},e,this)}));function t(){return e.apply(this,arguments)}return t}()},{key:"onSubmitChart",value:function(e,t){var n=this.state.charts;"create"===e?(n.push(t),H(t)):n.forEach(function(e,r){e.id===t.id&&(n[r]=t,H(t))}),this.setState({charts:n}),this.setState({formModalVisible:!1})}},{key:"onEditChart",value:function(e){this.setState({currentChart:e,formModalVisible:!0})}},{key:"onDeleteChart",value:function(e){this.setState({currentChart:e})}},{key:"onChartAdmin",value:function(e){this.setState({currentChart:e,chartAdminVisible:!0})}},{key:"onSubmintChartGrou",value:function(){this.setState({chartAdminVisible:!1})}},{key:"handleModalCancel",value:function(){this.setState({formModalVisible:!1,chartAdminVisible:!1})}},{key:"addChart",value:function(){this.setState({currentChart:void 0,formModalVisible:!0})}},{key:"handleChartDelete",value:function(){var e=p()(f.a.mark(function e(){var t,n,r,a;return f.a.wrap(function(e){while(1)switch(e.prev=e.next){case 0:return t=this.state,n=t.currentChart,r=t.charts,e.prev=1,e.next=4,Object(P["l"])({model:"chart__chart",id:n.id});case 4:e.next=10;break;case 6:return e.prev=6,e.t0=e["catch"](1),m["a"].error("\u5220\u9664\u5931\u8d25"),e.abrupt("return");case 10:a=r.map(function(e){return e.id}).indexOf(n.id),r.splice(a,1),this.setState({charts:r}),m["a"].success("\u5220\u9664\u6210\u529f");case 14:case"end":return e.stop()}},e,this,[[1,6]])}));function t(){return e.apply(this,arguments)}return t}()},{key:"handelChartEdit",value:function(e){var t=this.state.charts,n=_.find(t,{id:e});n&&this.setState({formModalVisible:!0})}},{key:"renderChart",value:function(e){var t=this,n=R.a.createElement(l["a"],null,R.a.createElement(l["a"].Item,{key:"1"},R.a.createElement(u["a"],{type:"default",size:"small",onClick:function(){t.onEditChart(e)},style:{marginRight:"5px"},icon:"form"},"\u56fe\u8868\u7f16\u8f91")),R.a.createElement(l["a"].Item,{key:"2"},R.a.createElement(u["a"],{type:"default",size:"small",style:{marginRight:"5px"},icon:"eye",onClick:function(){t.onChartAdmin(e)}},"\u56fe\u8868\u6743\u9650")));return R.a.createElement(c["a"],{span:11,style:{backgroundColor:"white",marginRight:"30px",marginBottom:"30px",padding:"10px",minWidth:"500px"}},R.a.createElement(a["a"],{type:"flex",justify:"space-between",style:{marginTop:"5px"}},R.a.createElement(c["a"],{style:{marginLeft:"5px",fontSize:"1.2em"}},R.a.createElement("span",null,e.name)),R.a.createElement(c["a"],{style:{marginRight:"5px"}},R.a.createElement("div",null,R.a.createElement(s["a"],{overlay:n,onClick:function(e){return e.preventDefault()}},R.a.createElement(o["a"],{type:"setting"})),R.a.createElement(i["a"],{title:"\u786e\u8ba4\u5220\u9664\u56fe\u8868\u4e48?",onConfirm:function(){t.handleChartDelete()},okText:"\u5220\u9664",cancelText:"\u53d6\u6d88",key:"delete"},R.a.createElement(u["a"],{onClick:function(){t.onDeleteChart(e)},style:{margin:5,border:0},icon:"delete"}))))),R.a.createElement(J["a"],{key:e.id,config:Y[e.id],id:e.id}))}},{key:"render",value:function(){var e=this,t=this.props.schemas,n=this.state,i=n.formModalVisible,s=n.charts,l=n.currentChart,m=n.chartAdminVisible;return R.a.createElement("div",null,R.a.createElement(a["a"],{type:"flex",justify:"start"},s.map(function(t){return e.renderChart(t)}),R.a.createElement(c["a"],{span:11},R.a.createElement(u["a"],{type:"dashed",style:{width:"100%",height:"540px"},onClick:function(){e.addChart()}},R.a.createElement("div",null,R.a.createElement(o["a"],{type:"plus-circle",theme:"filled",style:{fontSize:"5em"}})),R.a.createElement("div",{style:{marginTop:"10px"}},"\u6dfb\u52a0\u56fe\u8868")))),R.a.createElement(r["a"],{title:"".concat(l?"\u7f16\u8f91":"\u6dfb\u52a0","\u56fe\u8868"),placement:"right",width:800,onClose:function(){e.handleModalCancel()},visible:i,key:"form"},R.a.createElement(j["a"],{key:l&&l.id,schemas:t,templates:K["a"],initData:l,afterSubmit:function(t,n){e.onSubmitChart(t,n)}})),R.a.createElement(r["a"],{title:"\u67e5\u770b\u6743\u9650\u8bbe\u7f6e",placement:"right",width:800,visible:m,key:"chartAdmin",onClose:function(){e.handleModalCancel()}},R.a.createElement(z,{key:l&&l.id,initData:l,afterSubmit:function(){e.onSubmintChartGrou()}})))}}]),n}(D["Component"]))||I);t["default"]=W}}]);